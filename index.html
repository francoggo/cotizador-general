<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cotizador G3C</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    screens: {
                        'print': {'raw': 'print'},
                    },
                    colors: {
                        // Forzamos una paleta monocromática estricta
                        brand: {
                            black: '#000000',
                            dark: '#1a1a1a',
                            gray: '#4a4a4a',
                            light: '#e5e5e5',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @media print {
            @page { size: A4; margin: 0; }
            body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
        }
        .hidden-section { display: none; }
        
        /* Estilos de alto contraste para inputs */
        input, select, textarea {
            border-color: #d1d5db;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #000000 !important;
            box-shadow: 0 0 0 2px rgba(0,0,0,0.1) !important;
            outline: none;
        }
    </style>
</head>
<body class="min-h-screen bg-white font-sans text-slate-900 pb-20 print:pb-0">

    <header class="bg-black text-white p-4 sticky top-0 z-50 shadow-md print:hidden">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center">
                    <i data-lucide="building-2" class="text-black w-5 h-5"></i>
                </div>
                <h1 class="text-xl font-bold tracking-wider text-white">COTIZADOR <span class="font-light">G3C</span></h1>
            </div>
            <button id="btn-print-header" disabled class="bg-white hover:bg-gray-200 text-black px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed border border-gray-300" onclick="window.print()">
                <i data-lucide="printer" class="w-4 h-4"></i>
                <span class="hidden sm:inline">Exportar PDF</span>
            </button>
        </div>
    </header>

    <main class="max-w-4xl mx-auto p-4 sm:p-6 print:hidden">
        
        <div class="bg-white rounded-none border-l-4 border-black shadow-sm border-y border-r border-gray-200 mb-6 overflow-hidden">
            <button onclick="toggleSection('sec-info')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors">
                <div class="flex items-center gap-3 text-black font-bold uppercase tracking-wide">
                    <i data-lucide="folder-open" class="w-5 h-5"></i>
                    <span>Información del Proyecto</span>
                </div>
                <i data-lucide="chevron-down" class="text-gray-400 w-5 h-5"></i>
            </button>
            <div id="sec-info" class="p-5 border-t border-gray-100">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="col-span-1 md:col-span-2 mb-2">
                        <label class="block text-xs font-bold text-black mb-1 uppercase tracking-wider">Nombre del Proyecto</label>
                        <div class="relative">
                            <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500"><i data-lucide="building" class="w-4 h-4"></i></div>
                            <input type="text" id="input-proyecto" placeholder="Ej. Torre G3C Centro" class="w-full rounded-sm border bg-white py-3 pl-10 pr-3 text-sm font-semibold border-gray-300">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1 uppercase tracking-wider">Asesor</label>
                        <input type="text" id="input-asesor" class="w-full rounded-sm border bg-white border-gray-300 py-2 px-3 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1 uppercase tracking-wider">Cliente</label>
                        <input type="text" id="input-cliente" class="w-full rounded-sm border bg-white border-gray-300 py-2 px-3 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1 uppercase tracking-wider">Fecha</label>
                        <input type="date" id="input-fecha" class="w-full rounded-sm border bg-white border-gray-300 py-2 px-3 text-sm">
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-none border-l-4 border-black shadow-sm border-y border-r border-gray-200 mb-6 overflow-hidden">
            <button onclick="toggleSection('sec-unidad')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors">
                <div class="flex items-center gap-3 text-black font-bold uppercase tracking-wide">
                    <i data-lucide="home" class="w-5 h-5"></i>
                    <span>Unidad y Precio</span>
                </div>
                <i data-lucide="chevron-down" class="text-gray-400 w-5 h-5"></i>
            </button>
            <div id="sec-unidad" class="p-5 border-t border-gray-100">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-xs font-medium text-gray-500 mb-1 uppercase">Seleccionar Unidad (Opcional)</label>
                        <select id="select-unidad" class="w-full p-3 bg-white border border-gray-300 rounded-sm shadow-sm focus:ring-1 focus:ring-black focus:border-black text-base">
                            <option value="" selected>Selecciona o ingresa precio manual...</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-black mb-1 uppercase">Precio de Lista ($)</label>
                        <div class="relative">
                            <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-800 font-bold">$</div>
                            <input type="number" id="input-precio-manual" placeholder="0.00" class="w-full rounded-sm border border-gray-400 bg-gray-50 py-3 pl-8 pr-3 text-lg font-bold text-black shadow-sm focus:bg-white transition-colors">
                        </div>
                        <p class="text-[10px] text-gray-400 mt-1">* Puedes editar este precio manualmente.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="dynamic-content" class="hidden-section">
            
            <div class="bg-white rounded-none border-l-4 border-black shadow-sm border-y border-r border-gray-200 mb-6 overflow-hidden">
                <button onclick="toggleSection('sec-politica')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors">
                    <div class="flex items-center gap-3 text-black font-bold uppercase tracking-wide">
                        <i data-lucide="clock" class="w-5 h-5"></i>
                        <span>Condiciones Comerciales</span>
                    </div>
                    <i data-lucide="chevron-down" class="text-gray-400 w-5 h-5"></i>
                </button>
                <div id="sec-politica" class="p-5 border-t border-gray-100">
                    
                    <div class="bg-gray-100 p-4 rounded-sm border border-gray-300 mb-6">
                        <p class="text-sm font-bold text-black mb-2 uppercase">Descuento Especial</p>
                        <div class="flex gap-3">
                            <div class="flex-1">
                                <label class="block text-xs font-medium text-gray-500 mb-1 uppercase">Porcentaje (%)</label>
                                <div class="relative">
                                    <input type="number" id="input-desc-pct" value="0" class="w-full rounded-sm border border-gray-300 py-2 pl-3 pr-8 text-sm">
                                    <div class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">%</div>
                                </div>
                            </div>
                            <div class="flex-1">
                                <label class="block text-xs font-medium text-gray-500 mb-1 uppercase">Monto ($)</label>
                                <div class="relative">
                                    <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">$</div>
                                    <input type="number" id="input-desc-monto" value="0" class="w-full rounded-sm border border-gray-300 py-2 pl-8 pr-3 text-sm">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1 uppercase">Apartado ($)</label>
                            <input type="number" id="input-apartado" value="50000" class="w-full rounded-sm border border-gray-300 py-2 px-3 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1 uppercase">Inicio Mensualidad</label>
                            <input type="date" id="input-inicio-mensualidad" class="w-full rounded-sm border border-gray-300 py-2 px-3 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1 uppercase">Diferimiento (Meses)</label>
                            <input type="number" id="input-diferimiento" min="0" value="0" class="w-full rounded-sm border border-gray-300 py-2 px-3 text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1 uppercase">Diferir Enganche</label>
                            <select id="select-diferir-enganche" class="w-full p-2 bg-white border border-gray-300 rounded-sm text-sm h-[38px]">
                                <option value="1">1 Pago (Inmediato)</option>
                                <option value="2">2 Meses</option>
                                <option value="3">3 Meses</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-none border-l-4 border-black shadow-sm border-y border-r border-gray-200 mb-6 overflow-hidden">
                <button onclick="toggleSection('sec-esquema')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors">
                    <div class="flex items-center gap-3 text-black font-bold uppercase tracking-wide">
                        <i data-lucide="calculator" class="w-5 h-5"></i>
                        <span>Esquema de Pago</span>
                    </div>
                    <i data-lucide="chevron-down" class="text-gray-400 w-5 h-5"></i>
                </button>
                <div id="sec-esquema" class="p-5 border-t border-gray-100 space-y-6">
                    
                    <div>
                        <div class="flex justify-between mb-1"><label class="font-bold text-black text-sm">1. Enganche (<span id="lbl-enganche-pct">30.0</span>%)</label></div>
                        <input type="range" id="range-enganche" min="1" max="100" step="0.5" value="30" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-black mb-2">
                        <div class="flex gap-4">
                            <div class="w-24 relative">
                                <input type="number" id="input-enganche-pct" value="30" class="w-full rounded-sm border border-gray-300 py-2 pl-2 pr-6 text-sm">
                                <div class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">%</div>
                            </div>
                            <div class="flex-1 relative">
                                <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</div>
                                <input type="number" id="input-enganche-monto" class="w-full rounded-sm border border-gray-300 py-2 pl-8 pr-3 text-sm font-medium">
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="flex justify-between mb-1"><label class="font-bold text-black text-sm">2. Financiado (<span id="lbl-financiado-pct">50.0</span>%)</label></div>
                        <input type="range" id="range-financiado" min="0" max="100" step="0.5" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-black mb-2">
                        <div class="flex gap-4">
                            <div class="w-24 relative">
                                <input type="number" id="input-financiado-pct" value="50" class="w-full rounded-sm border border-gray-300 py-2 pl-2 pr-6 text-sm">
                                <div class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">%</div>
                            </div>
                            <div class="flex-1 relative">
                                <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</div>
                                <input type="number" id="input-financiado-monto" class="w-full rounded-sm border border-gray-300 py-2 pl-8 pr-3 text-sm font-medium">
                            </div>
                        </div>
                        <div id="plazos-container" class="mt-3 flex flex-wrap gap-2"></div>
                    </div>

                    <div>
                        <div class="flex justify-between mb-1"><label class="font-bold text-black text-sm">3. Contra Entrega (<span id="lbl-contra-pct">20.0</span>%)</label></div>
                        <input type="range" id="range-contra" min="0" max="100" step="0.5" value="20" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-gray-600 mb-2">
                        <div class="flex gap-4">
                            <div class="w-24 relative">
                                <input type="number" id="input-contra-pct" value="20" class="w-full rounded-sm border border-gray-300 py-2 pl-2 pr-6 text-sm">
                                <div class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">%</div>
                            </div>
                            <div class="flex-1 relative">
                                <div class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">$</div>
                                <input type="number" id="input-contra-monto" class="w-full rounded-sm border border-gray-300 py-2 pl-8 pr-3 text-sm font-medium">
                            </div>
                        </div>
                    </div>

                    <div id="error-suma" class="text-red-600 text-xs font-bold hidden-section mt-2 border border-red-200 bg-red-50 p-2">
                        ⚠️ Suma total: <span id="lbl-suma-total">0</span>% (Debe ser 100%)
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-none border-l-4 border-black shadow-sm border-y border-r border-gray-200 mb-6 overflow-hidden">
                <button onclick="toggleSection('sec-obs')" class="w-full flex items-center justify-between p-4 bg-gray-50 hover:bg-gray-100 transition-colors">
                    <div class="flex items-center gap-3 text-black font-bold uppercase tracking-wide">
                        <i data-lucide="message-square" class="w-5 h-5"></i>
                        <span>Observaciones / Anexos</span>
                    </div>
                    <i data-lucide="chevron-down" class="text-gray-400 w-5 h-5"></i>
                </button>
                <div id="sec-obs" class="p-5 border-t border-gray-100">
                    <textarea id="input-observaciones" rows="4" placeholder="Escribe aquí cualquier comentario, condición especial o anexo..." class="w-full p-3 border border-gray-300 rounded-sm text-sm focus:border-black transition-colors"></textarea>
                </div>
            </div>

        </div>
    </main>

    <div id="sticky-footer" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-300 p-4 z-40 print:hidden shadow-[0_-5px_20px_rgba(0,0,0,0.1)] hidden-section">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
           <div>
             <p class="text-[10px] text-gray-500 uppercase font-bold tracking-widest">Mensualidad Estimada</p>
             <p id="txt-mensualidad-footer" class="text-2xl font-black text-black tracking-tight">$0.00</p>
           </div>
           <button onclick="window.print()" class="bg-black text-white px-6 py-3 rounded-md font-bold shadow-lg flex items-center gap-2 hover:bg-gray-800 transition-all border border-gray-800">
             <i data-lucide="file-text" class="w-5 h-5"></i>
             <span class="hidden sm:inline">Generar PDF</span>
             <span class="sm:hidden">PDF</span>
           </button>
        </div>
     </div>

    <div id="print-layout" class="hidden print:flex flex-col bg-white w-[210mm] min-h-[297mm] mx-auto p-[10mm] relative box-border font-serif text-black">
        
        <div class="relative z-10 h-full flex flex-col justify-between">
            
            <div class="flex justify-between items-end border-b-4 border-black pb-4 mb-6">
               <div>
                   <h1 class="text-5xl font-black text-black tracking-tighter leading-none font-sans">G3C</h1>
                   <p class="text-sm text-gray-500 tracking-[0.3em] uppercase font-bold mt-1">COTIZADOR INMOBILIARIO</p>
               </div>
               <div class="text-right">
                   <h2 id="print-proyecto-header" class="text-lg font-bold text-black uppercase mb-1">PROYECTO</h2>
                   <p class="text-xs text-gray-500 font-sans">Folio: <span id="print-folio" class="text-black font-bold">0000</span></p>
                   <p id="print-fecha" class="text-xs text-black font-medium mt-1">Fecha</p>
               </div>
            </div>

            <div class="grid grid-cols-12 gap-8 mb-6">
                <div class="col-span-4 space-y-4">
                    <div class="border-l-2 border-black pl-3">
                        <span class="block text-[9px] text-gray-400 uppercase tracking-widest mb-1">Cliente</span>
                        <p id="print-cliente" class="font-bold text-black text-base leading-tight">Por definir</p>
                    </div>
                    <div class="border-l-2 border-black pl-3">
                        <span class="block text-[9px] text-gray-400 uppercase tracking-widest mb-1">Asesor</span>
                        <p id="print-asesor" class="font-bold text-black text-base leading-tight">Por asignar</p>
                    </div>
                </div>

                <div class="col-span-8 bg-gray-50 p-4 border border-gray-200">
                     <h3 class="text-[10px] font-bold text-black uppercase tracking-wider mb-4 border-b border-gray-300 pb-2">Detalles de la Unidad</h3>
                     <div class="grid grid-cols-2 gap-y-4 gap-x-6 font-sans">
                        <div class="flex items-center gap-3">
                            <div>
                                <span class="block text-[9px] text-gray-500 uppercase">Unidad</span>
                                <span id="print-unidad" class="font-bold text-xl text-black">---</span>
                            </div>
                        </div>
                         <div class="flex items-center gap-3">
                            <div>
                                <span class="block text-[9px] text-gray-500 uppercase">Precio Lista</span>
                                <span id="print-precio-lista" class="font-bold text-lg text-black">$0.00</span>
                            </div>
                        </div>
                        <div class="col-span-2">
                            <span class="block text-[9px] text-gray-500 uppercase">Características</span>
                            <span id="print-caracteristicas" class="font-medium text-sm text-gray-800">---</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <div class="bg-black text-white px-3 py-1 mb-2 inline-block">
                    <h3 class="text-xs font-bold uppercase tracking-wide font-sans">Resumen Financiero</h3>
                </div>
                
                <table class="w-full text-xs font-sans border-collapse">
                    <thead class="bg-gray-100 text-black font-bold border-y-2 border-black">
                        <tr>
                            <th class="py-2 px-3 text-left w-1/3">CONCEPTO</th>
                            <th class="py-2 px-3 text-center">PORCENTAJE</th>
                            <th class="py-2 px-3 text-right">MONTO</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200 text-gray-800">
                         <tr id="row-descuento" class="hidden-section">
                             <td class="py-2 px-3 font-medium italic">(-) Descuento Aplicado</td>
                             <td id="print-desc-pct" class="py-2 px-3 text-center">0%</td>
                             <td id="print-desc-monto" class="py-2 px-3 text-right font-bold">- $0.00</td>
                         </tr>
                         <tr class="bg-gray-50 font-bold text-black border-t-2 border-black">
                             <td class="py-3 px-3">PRECIO NETO FINAL</td>
                             <td class="py-3 px-3 text-center">100%</td>
                             <td id="print-precio-final" class="py-3 px-3 text-right text-sm">$0.00</td>
                         </tr>
                    </tbody>
                </table>
            </div>

            <div class="mb-4 flex-grow">
                 <div class="bg-black text-white px-3 py-1 mb-2 inline-block">
                    <h3 class="text-xs font-bold uppercase tracking-wide font-sans">Esquema de Pagos</h3>
                </div>

                <table class="w-full text-[11px] font-sans mb-6 border-b border-black">
                    <tbody class="divide-y divide-gray-200">
                         <tr>
                             <td class="py-2 font-bold text-black w-1/3 pl-2">1. Pago Inicial (Apartado)</td>
                             <td class="py-2 text-center text-gray-400">—</td>
                             <td id="print-apartado" class="py-2 text-right font-bold text-black pr-2">$0.00</td>
                         </tr>
                         <tr>
                             <td class="py-2 pl-2">
                                <span class="font-bold text-black">2. Enganche Complementario</span>
                                <span id="print-diferir-txt" class="block text-[9px] text-gray-500 italic pl-3 hidden-section"></span>
                             </td>
                             <td id="print-enganche-pct" class="py-2 text-center font-medium">0%</td>
                             <td id="print-enganche-monto" class="py-2 text-right font-medium pr-2">$0.00</td>
                         </tr>
                         <tr class="bg-gray-50">
                             <td class="py-2 pl-2">
                                <span class="font-bold text-black">3. Financiado (<span id="print-plazo-meses">12</span> Meses)</span>
                                <span id="print-inicio-financiado" class="block text-[9px] text-gray-500 pl-3">Inicio: ---</span>
                             </td>
                             <td id="print-financiado-pct" class="py-2 text-center font-bold text-black">0%</td>
                             <td id="print-financiado-monto" class="py-2 text-right font-bold text-black pr-2">$0.00</td>
                         </tr>
                         <tr>
                             <td class="py-2 pl-2 font-bold text-black">4. Contra Entrega</td>
                             <td id="print-contra-pct" class="py-2 text-center font-medium">0%</td>
                             <td id="print-contra-monto" class="py-2 text-right font-medium pr-2">$0.00</td>
                         </tr>
                    </tbody>
                </table>

                <div id="print-observaciones-box" class="mb-4 border border-gray-300 p-3 min-h-[60px] hidden-section">
                    <h4 class="text-[9px] font-bold text-black uppercase mb-1">Observaciones / Anexos:</h4>
                    <p id="print-observaciones-text" class="text-[10px] text-gray-700 whitespace-pre-wrap leading-tight"></p>
                </div>

                <div class="border border-black p-0">
                    <div class="bg-black text-white text-[9px] font-bold uppercase py-1 text-center tracking-widest">Calendario de Pagos</div>
                    <div class="grid grid-cols-6 gap-2 text-[9px] text-center font-sans font-bold text-black border-b border-gray-300 py-1 bg-gray-100">
                        <div>No.</div>
                        <div class="col-span-2">Fecha</div>
                        <div class="col-span-2 text-right">Monto</div>
                        <div class="text-right pr-2">Saldo</div>
                    </div>
                    <div id="amortizacion-rows" class="divide-y divide-gray-100">
                        </div>
                </div>
            </div>

            <div class="mt-auto font-sans pt-4">
                <div class="border-t-2 border-black pt-3 text-center">
                     <p class="text-[8px] text-gray-500 uppercase tracking-wider">
                        Documento generado por Cotizador G3C. Precios sujetos a cambio sin previo aviso.
                     </p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- DATA ---
        // Inventario de ejemplo (puedes añadir o quitar, pero ahora tenemos precio manual)
        const INVENTARIO = [
            { id: '101', unidad: '101', recamaras: 1, area: 47.63, precio: 2145000, estado: 'Disponible', nivel: 1 },
            { id: '201', unidad: '201', recamaras: 2, area: 62.49, precio: 3054804, estado: 'Disponible', nivel: 2 },
            { id: '303', unidad: '303', recamaras: 2, area: 65.12, precio: 3201716, estado: 'Disponible', nivel: 3 },
            { id: 'PH1', unidad: 'PH-1', recamaras: 3, area: 120.00, precio: 5500000, estado: 'Disponible', nivel: 5 },
        ];

        const PLAZOS = [1, 3, 6, 12, 18, 24];

        // --- STATE ---
        let STATE = {
            proyecto: '',
            fecha: new Date().toISOString().split('T')[0],
            asesor: '',
            cliente: '',
            unidadSeleccionada: null,
            precioManual: 0,
            precioBase: 0,
            observaciones: '',
            descuentoMonto: 0,
            descuentoPorcentaje: 0,
            enganchePorcentaje: 30,
            engancheMonto: 0,
            financiadoPorcentaje: 50,
            financiadoMonto: 0,
            contraEntregaPorcentaje: 20,
            contraEntregaMonto: 0,
            plazoMeses: 12,
            apartado: 50000,
            diferirEnganche: 1,
            fechaInicioMensualidad: new Date().toISOString().split('T')[0],
            mesesDiferido: 0,
            precioFinal: 0
        };

        // --- UTILS ---
        const formatMoney = (amount) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 2 }).format(amount);

        const createUTCDate = (dateString) => {
            const [year, month, day] = dateString.split('-').map(Number);
            return new Date(Date.UTC(year, month - 1, day, 12, 0, 0));
        };

        const formatDate = (dateString) => {
            if (!dateString) return 'No definida';
            const date = createUTCDate(dateString);
            const options = { year: 'numeric', month: 'short', day: 'numeric', timeZone: 'UTC' };
            return date.toLocaleDateString('es-MX', options).toUpperCase();
        };

        const addMonths = (dateString, months) => {
            if (!dateString) return null;
            const date = createUTCDate(dateString);
            date.setUTCMonth(date.getUTCMonth() + parseInt(months));
            return date.toISOString().split('T')[0];
        };

        // --- LOGIC ---

        function init() {
            // Populate Unit Select
            const select = document.getElementById('select-unidad');
            INVENTARIO.forEach(u => {
                const option = document.createElement('option');
                option.value = u.id;
                option.text = `${u.unidad} (${formatMoney(u.precio)})`;
                select.appendChild(option);
            });

            // Populate Plazo Buttons
            const plazosContainer = document.getElementById('plazos-container');
            PLAZOS.forEach(p => {
                const btn = document.createElement('button');
                btn.innerText = `${p} Meses`;
                btn.className = 'px-3 py-1 rounded-sm text-xs font-bold border border-gray-300 bg-white hover:bg-gray-100 text-gray-600 transition-colors';
                btn.onclick = () => setPlazo(p);
                btn.dataset.plazo = p;
                plazosContainer.appendChild(btn);
            });

            // Set Initial Date
            document.getElementById('input-fecha').value = STATE.fecha;
            document.getElementById('input-inicio-mensualidad').value = STATE.fechaInicioMensualidad;
            
            // Initialize Icons
            lucide.createIcons();
            
            // Bind Events
            bindEvents();
        }

        function bindEvents() {
            // Info Global
            const bindInput = (id, key) => {
                document.getElementById(id).addEventListener('input', (e) => { 
                    STATE[key] = e.target.value; 
                    updatePrintView(); 
                });
            };
            
            bindInput('input-proyecto', 'proyecto');
            bindInput('input-asesor', 'asesor');
            bindInput('input-cliente', 'cliente');
            bindInput('input-observaciones', 'observaciones');
            
            document.getElementById('input-fecha').addEventListener('change', (e) => { STATE.fecha = e.target.value; updatePrintView(); });

            // Unidad y Precio
            document.getElementById('select-unidad').addEventListener('change', (e) => {
                const id = e.target.value;
                STATE.unidadSeleccionada = INVENTARIO.find(u => u.id === id);
                
                if (STATE.unidadSeleccionada) {
                    STATE.precioBase = STATE.unidadSeleccionada.precio;
                    // Actualizamos el input manual visualmente
                    document.getElementById('input-precio-manual').value = STATE.precioBase;
                }
                activateCalculator();
            });

            // Nuevo: Precio Manual trigger
            document.getElementById('input-precio-manual').addEventListener('input', (e) => {
                const val = Number(e.target.value);
                STATE.precioBase = val;
                // Si escriben manual, deseleccionamos unidad si no coincide (opcional, aqui solo recalculamos)
                activateCalculator();
            });

            // Descuentos
            document.getElementById('input-desc-pct').addEventListener('input', (e) => handleDescuento(e.target.value, 'pct'));
            document.getElementById('input-desc-monto').addEventListener('input', (e) => handleDescuento(e.target.value, 'amt'));

            // Tiempos
            document.getElementById('input-apartado').addEventListener('input', (e) => { STATE.apartado = Number(e.target.value); recalculate(); });
            document.getElementById('input-inicio-mensualidad').addEventListener('change', (e) => { STATE.fechaInicioMensualidad = e.target.value; recalculate(); });
            document.getElementById('input-diferimiento').addEventListener('input', (e) => { STATE.mesesDiferido = Number(e.target.value); recalculate(); });
            document.getElementById('select-diferir-enganche').addEventListener('change', (e) => { STATE.diferirEnganche = Number(e.target.value); recalculate(); });

            // Esquema
            const bindEsquema = (id, field, type) => {
                document.getElementById(id).addEventListener('input', (e) => handleEsquema(e.target.value, field, type));
            };

            bindEsquema('range-enganche', 'enganche', 'pct');
            bindEsquema('input-enganche-pct', 'enganche', 'pct');
            bindEsquema('input-enganche-monto', 'enganche', 'amount');

            bindEsquema('range-financiado', 'financiado', 'pct');
            bindEsquema('input-financiado-pct', 'financiado', 'pct');
            bindEsquema('input-financiado-monto', 'financiado', 'amount');

            bindEsquema('range-contra', 'contra', 'pct');
            bindEsquema('input-contra-pct', 'contra', 'pct');
            bindEsquema('input-contra-monto', 'contra', 'amount');
        }

        function activateCalculator() {
            // Reset Descuentos
            STATE.descuentoMonto = 0;
            STATE.descuentoPorcentaje = 0;
            // Show UI
            document.getElementById('dynamic-content').style.display = 'block';
            document.getElementById('sticky-footer').style.display = 'block';
            document.getElementById('btn-print-header').disabled = false;
            recalculate();
        }

        function handleDescuento(val, type) {
            const numVal = Number(val);
            if (type === 'pct') {
                STATE.descuentoPorcentaje = numVal;
                STATE.descuentoMonto = STATE.precioBase * (numVal / 100);
            } else {
                STATE.descuentoMonto = numVal;
                if (STATE.precioBase > 0) STATE.descuentoPorcentaje = (numVal / STATE.precioBase) * 100;
            }
            recalculate();
        }

        function handleEsquema(val, field, type) {
            const numVal = Number(val);
            let nuevoPct = 0;
            
            if (type === 'amount') {
                if (STATE.precioFinal > 0) nuevoPct = (numVal / STATE.precioFinal) * 100;
            } else {
                nuevoPct = numVal;
            }

            if (field === 'enganche') {
                STATE.enganchePorcentaje = nuevoPct;
                STATE.contraEntregaPorcentaje = Math.max(0, 100 - nuevoPct - STATE.financiadoPorcentaje);
            } else if (field === 'financiado') {
                STATE.financiadoPorcentaje = nuevoPct;
                STATE.contraEntregaPorcentaje = Math.max(0, 100 - STATE.enganchePorcentaje - nuevoPct);
            } else if (field === 'contra') {
                STATE.contraEntregaPorcentaje = nuevoPct;
                STATE.financiadoPorcentaje = Math.max(0, 100 - STATE.enganchePorcentaje - nuevoPct);
            }
            recalculate();
        }

        function setPlazo(p) {
            STATE.plazoMeses = p;
            recalculate();
        }

        function recalculate() {
            // 1. Calcular Precio Final
            STATE.precioFinal = STATE.precioBase - STATE.descuentoMonto;

            // 2. Calcular Montos basado en Porcentajes
            STATE.engancheMonto = STATE.precioFinal * (STATE.enganchePorcentaje / 100);
            STATE.financiadoMonto = STATE.precioFinal * (STATE.financiadoPorcentaje / 100);
            STATE.contraEntregaMonto = STATE.precioFinal * (STATE.contraEntregaPorcentaje / 100);

            updateUI();
        }

        function updateUI() {
            // Descuentos
            document.getElementById('input-desc-pct').value = STATE.descuentoPorcentaje.toFixed(2);
            document.getElementById('input-desc-monto').value = STATE.descuentoMonto.toFixed(0);

            // Esquema
            document.getElementById('range-enganche').value = STATE.enganchePorcentaje;
            document.getElementById('input-enganche-pct').value = STATE.enganchePorcentaje.toFixed(1);
            document.getElementById('input-enganche-monto').value = Math.round(STATE.engancheMonto);
            document.getElementById('lbl-enganche-pct').innerText = STATE.enganchePorcentaje.toFixed(1);

            document.getElementById('range-financiado').value = STATE.financiadoPorcentaje;
            document.getElementById('input-financiado-pct').value = STATE.financiadoPorcentaje.toFixed(1);
            document.getElementById('input-financiado-monto').value = Math.round(STATE.financiadoMonto);
            document.getElementById('lbl-financiado-pct').innerText = STATE.financiadoPorcentaje.toFixed(1);

            document.getElementById('range-contra').value = STATE.contraEntregaPorcentaje;
            document.getElementById('input-contra-pct').value = STATE.contraEntregaPorcentaje.toFixed(1);
            document.getElementById('input-contra-monto').value = Math.round(STATE.contraEntregaMonto);
            document.getElementById('lbl-contra-pct').innerText = STATE.contraEntregaPorcentaje.toFixed(1);

            // Plazo Buttons Active State
            const btns = document.getElementById('plazos-container').children;
            for (let btn of btns) {
                // Estilo blanco y negro seleccionado
                if (Number(btn.dataset.plazo) === STATE.plazoMeses) {
                    btn.className = 'px-3 py-1 rounded-sm text-xs font-bold border border-black bg-black text-white transition-colors';
                } else {
                    btn.className = 'px-3 py-1 rounded-sm text-xs font-bold border border-gray-300 bg-white text-gray-600 transition-colors';
                }
            }

            // Suma Check
            const suma = Number(STATE.enganchePorcentaje) + Number(STATE.financiadoPorcentaje) + Number(STATE.contraEntregaPorcentaje);
            const errorDiv = document.getElementById('error-suma');
            if (suma.toFixed(0) !== "100") {
                errorDiv.style.display = 'block';
                document.getElementById('lbl-suma-total').innerText = suma.toFixed(1);
            } else {
                errorDiv.style.display = 'none';
            }

            // Footer Mensualidad
            const mensualidad = STATE.plazoMeses > 0 ? STATE.financiadoMonto / STATE.plazoMeses : 0;
            document.getElementById('txt-mensualidad-footer').innerText = formatMoney(mensualidad);

            updatePrintView();
        }

        function updatePrintView() {
            // Header
            document.getElementById('print-folio').innerText = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            document.getElementById('print-fecha').innerText = formatDate(STATE.fecha);
            document.getElementById('print-cliente').innerText = STATE.cliente || 'Por definir';
            document.getElementById('print-asesor').innerText = STATE.asesor || 'Por asignar';
            
            // Proyecto Header
            const proyectoPrint = STATE.proyecto ? STATE.proyecto : 'PROYECTO';
            document.getElementById('print-proyecto-header').innerText = proyectoPrint;

            // Unit Info
            if (STATE.unidadSeleccionada) {
                document.getElementById('print-unidad').innerText = STATE.unidadSeleccionada.unidad;
                document.getElementById('print-caracteristicas').innerText = `Nivel ${STATE.unidadSeleccionada.nivel} / ${STATE.unidadSeleccionada.recamaras} Rec / ${STATE.unidadSeleccionada.area} m²`;
            } else {
                document.getElementById('print-unidad').innerText = "Personalizada";
                document.getElementById('print-caracteristicas').innerText = "Cotización manual";
            }
            document.getElementById('print-precio-lista').innerText = formatMoney(STATE.precioBase);

            // Observaciones
            const obsBox = document.getElementById('print-observaciones-box');
            if (STATE.observaciones && STATE.observaciones.trim() !== '') {
                obsBox.style.display = 'block';
                document.getElementById('print-observaciones-text').innerText = STATE.observaciones;
            } else {
                obsBox.style.display = 'none';
            }

            // Financial Summary
            const rowDesc = document.getElementById('row-descuento');
            if (STATE.descuentoMonto > 0) {
                rowDesc.style.display = 'table-row';
                document.getElementById('print-desc-pct').innerText = `${STATE.descuentoPorcentaje.toFixed(2)}%`;
                document.getElementById('print-desc-monto').innerText = `- ${formatMoney(STATE.descuentoMonto)}`;
            } else {
                rowDesc.style.display = 'none';
            }
            document.getElementById('print-precio-final').innerText = formatMoney(STATE.precioFinal);

            // Esquema Table
            document.getElementById('print-apartado').innerText = formatMoney(STATE.apartado);
            
            const engancheNeto = Math.max(0, STATE.engancheMonto - STATE.apartado);
            document.getElementById('print-enganche-pct').innerText = `${STATE.enganchePorcentaje.toFixed(2)}%`;
            document.getElementById('print-enganche-monto').innerText = formatMoney(engancheNeto);
            
            const difTxt = document.getElementById('print-diferir-txt');
            if (STATE.diferirEnganche > 1) {
                difTxt.style.display = 'block';
                difTxt.innerText = `↳ Diferido en ${STATE.diferirEnganche} pagos mensuales`;
            } else {
                difTxt.style.display = 'none';
            }

            document.getElementById('print-plazo-meses').innerText = STATE.plazoMeses;
            const fechaInicioPagosReal = STATE.mesesDiferido > 0 
                ? addMonths(STATE.fechaInicioMensualidad, STATE.mesesDiferido) 
                : STATE.fechaInicioMensualidad;
            
            let inicioText = `${formatDate(fechaInicioPagosReal)}`;
            if(STATE.mesesDiferido > 0) inicioText += ` (+${STATE.mesesDiferido} m diferido)`;
            document.getElementById('print-inicio-financiado').innerText = "Inicio: " + inicioText;

            document.getElementById('print-financiado-pct').innerText = `${STATE.financiadoPorcentaje.toFixed(2)}%`;
            document.getElementById('print-financiado-monto').innerText = formatMoney(STATE.financiadoMonto);

            document.getElementById('print-contra-pct').innerText = `${STATE.contraEntregaPorcentaje.toFixed(2)}%`;
            document.getElementById('print-contra-monto').innerText = formatMoney(STATE.contraEntregaMonto);

            // Mini Tabla Amortización
            generateAmortizacionTable(fechaInicioPagosReal);
        }

        function generateAmortizacionTable(fechaInicioReal) {
            const container = document.getElementById('amortizacion-rows');
            container.innerHTML = '';
            
            const mensualidadFinanciada = STATE.plazoMeses > 0 ? STATE.financiadoMonto / STATE.plazoMeses : 0;
            let count = 0;

            // DIF rows
            for (let i = 1; i <= Math.min(STATE.mesesDiferido, 3); i++) {
                const fechaPago = addMonths(STATE.fechaInicioMensualidad, i);
                addRow(container, 'DIF', formatDate(fechaPago), '---', formatMoney(STATE.financiadoMonto), true);
                count++;
            }

            // Normal rows
            for (let i = 1; i <= STATE.plazoMeses; i++) {
                const fechaPago = addMonths(fechaInicioReal, i - 1);
                const saldoRestante = STATE.financiadoMonto - (mensualidadFinanciada * i);
                const saldoDisplay = saldoRestante < 1 ? 0 : saldoRestante;
                
                addRow(container, i, formatDate(fechaPago), formatMoney(mensualidadFinanciada), formatMoney(saldoDisplay), false);
                count++;
            }
        }

        function addRow(container, num, fecha, monto, saldo, isDif) {
            const div = document.createElement('div');
            // Estilo filas alternadas gris claro
            const bgClass = (typeof num === 'number' && num % 2 === 0) ? 'bg-gray-50' : 'bg-white';
            div.className = `grid grid-cols-6 gap-2 text-[9px] text-center font-sans py-1 text-black ${bgClass}`;
            div.innerHTML = `
                <div>${num}</div>
                <div class="col-span-2">${fecha}</div>
                <div class="col-span-2 text-right font-medium">${monto}</div>
                <div class="text-right pr-2 text-gray-500">${saldo}</div>
            `;
            container.appendChild(div);
        }

        function toggleSection(id) {
            const el = document.getElementById(id);
            if (el.style.display === 'none') el.style.display = 'block';
            else el.style.display = 'none';
        }

        // Initial Run
        init();
    </script>
</body>
</html>
